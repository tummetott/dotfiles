# vim: set ft=bash:

{{ if .sudo }}
    info 'Upgrade and autoremove apt packages'

    export DEBIAN_FRONTEND=noninteractive
    export DEBIAN_PRIORITY=critical
    log sudo -E apt-get -qy update
    log sudo -E apt-get -qy \
        -o Dpkg::Options::="--force-confdef" \
        -o Dpkg::Options::="--force-confold" upgrade
    log sudo -E apt-get -qy autoremove

    if [ ! -f "$XDG_CONFIG_HOME/aptitude/Aptfile" ]; then
        error 'Could not find Aptfile'
        exit 1
    fi

    while read -r line; do
        if ! apt list --installed 2>/dev/null | grep -q "^$line"; then
            info "Installing $line"
            log sudo -E apt-get -qy install "$line"
        fi
    done < <(grep -vE '^\s*(#|$)' "$XDG_CONFIG_HOME/aptitude/Aptfile")
{{ else }}
    warn "Skipping apt installation (missing sudo)"
{{ end }}

