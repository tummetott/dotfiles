######## GLOBAL SETTING

# Ideally, terminfo should be 'tmux-256color' in order to support italic fonts.
# Unforunately, macOS comes with ncurses version 5.7 which does not ship the
# terminfo description for tmux. Upgrading ncurses with homebrew is not an
# option since ncurses versions are incompatible and many system programs would
# break with the update. Downloading the most recent terminfo database from
# version 6.3 and building with 5.7 works but breaks the colors in some programs
# (eg. htop). However, it is possible to download and build the terminfo from
# the tmux maintainers (see bootstrap script). If there are problems with
# 'tmux-256color', 'screen-256color' can always be used as a fallback (without
# italic font support). Note: terminfo of the terminal emulator != terminfo of
# tmux
set -g default-terminal 'tmux-256color'

# When the terminfo value is 'alacritty-direct' tmux automatically detects
# truecolor support. For other terminals, ensure truecolor support in tmux by
# setting the 'RGB' flag. These settings are applicable to tmux 3.2 and later;
# please consult the manual if you are using older versions.
set -sa terminal-features ',alacritty:RGB'
set -sa terminal-features ',xterm-kitty:RGB'
set -sa terminal-features ',xterm-256color:RGB'

# Disable delay time between commands
set -s escape-time 0

# Longer display time for tmux messages
set -g display-time 2000

# Turn on mouse control
set -g mouse on

# Focus events are requested from the terminal if supported and passed through
# to applications
set -s focus-events on

# Increase scrollback buffer size
set -g history-limit 50000

# Automatically renumber tmux windows
set -g renumber-windows on

# Increase the refresh frequency of 'status-left' and 'status-right'
set -g status-interval 5

# Make window / pane index start with 1
set -g base-index 1
set -g pane-base-index 1

# Left side just shows my windows, no status element
set -g status-left ''

# Set length of status-right to a bigger value
set -g status-right-length 80

setw -g mode-keys vi

# Color-dependent settings are centralized in a dedicated shell script, enabling
# conditional branching to adapt to the chosen color scheme.
run $XDG_CONFIG_HOME/tmux/style.tmux

######## KEYBINDINGS

# Remap prefix from C-b to C-SPC
unbind C-b
set -g prefix C-Space
bind C-Space send-prefix

# TODO: To avoid accidental key mispresses, most of the keymaps are mapped
# twice. First as <prefix> <keymap>, second as <prefix> C-<keymap>

bind t new-window
bind s split-window -h -c "#{pane_current_path}"
bind u split-window -v -c "#{pane_current_path}"
bind w kill-pane
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R
bind p previous-window
bind n next-window

bind -N 'Forward search' f copy-mode -H \; command-prompt -i -p 'Search down:' \
    'send -X search-forward-incremental "%%%"'
bind -N 'Forward search' / copy-mode -H \; command-prompt -i -p 'Search down:' \
    'send -X search-forward-incremental "%%%"'
bind -N 'Backward search' ? copy-mode -H \; command-prompt -i -p 'Search up:' \
    'send -X search-backward-incremental "%%%"'

# Exit copy mode
bind -T copy-mode-vi Escape send -X cancel

bind d detach-client

# enter move mode with prefix m
bind m set -w -g key-table move \; display-message "MOVE"

# exit move mode
bind -T move Escape set -g key-table root \; display-message "NORMAL"
bind -T move C-c    set -g key-table root \; display-message "NORMAL"
bind -T move Enter set -g key-table root \; display-message "NORMAL"

# move panes
bind -T move h swap-pane -t '{left-of}'
bind -T move j swap-pane -t '{down-of}'
bind -T move k swap-pane -t '{up-of}'
bind -T move l swap-pane -t '{right-of}'

# cycle layouts
bind -T move n next-layout
bind -T move p previous-layout

# TODO: improve the open in editor thing
bind E capture-pane -S - \; choose-buffer

# enter resize mode with prefix z
bind z set -w -g key-table resize \; display-message "RESIZE"

# exit resize mode
bind -T resize Escape set -g key-table root \; display-message "NORMAL"
bind -T resize C-c    set -g key-table root \; display-message "NORMAL"
bind -T resize Enter  set -g key-table root \; display-message "NORMAL"

# resize panes (vim style)
bind -T resize h resize-pane -L 12
bind -T resize j resize-pane -D 12
bind -T resize k resize-pane -U 12
bind -T resize l resize-pane -R 12

bind r command-prompt -p "Rename window:" "rename-window '%%'"

# Run 'chezmoi apply' in a new window. Wait for keyboard input (e.g. CR) in case
# the cmd did finish with an error.
bind -N 'Chezmoi apply' a new-window 'zsh -c "chezmoi apply || read -r"'
bind -N 'Chezmoi apply' C-a new-window 'zsh -c "chezmoi apply || read -r"'

bind x send -R \; clear-history -H \; send C-l
bind o resize-pane -Z
bind b last-window

# Reload tmux.conf with CMD r
bind -n M-r source-file $XDG_CONFIG_HOME/tmux/tmux.conf \;\
    display "TMUX config reloaded!"

# This keymap is the default, I just added the -H flag to supress the ugly
# posiiton indicator in the top right
bind -n MouseDrag1Pane if -F "#{||:#{pane_in_mode},#{mouse_any_flag}}" { send -M } { copy-mode -M -H }

# Vim commands in copy mode
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi V send -X select-line
bind -T copy-mode-vi y send -X copy-selection-and-cancel
bind -T copy-mode-vi C-v send -X rectangle-toggle \; send -X begin-selection

# Use incremental search inside copy mode
bind -T copy-mode-vi / command-prompt -i -p 'Search down:' \
    'send -X search-forward-incremental "%%%"'
bind -T copy-mode-vi ? command-prompt -i -p 'Search up:' \
    'send -X search-backward-incremental "%%%"'

# # HACK: tmux struggles to differentiate between TAB and C-i, as well as CR and
# # C-m. Even when sending the correct 'CSI u' sequence for C-i and C-m, tmux
# # v3.3a may incorrectly interpret these as TAB or CR. To tackle this issue, I've
# # configured my terminal emulator to send a custom escape sequence (\e[555;0)
# # ahead of the 'CSI u' sequence for the key in question. This custom sequence
# # serves as a modifier to indicate that the subsequent sequence should not be
# # interpreted as TAB or CR but as C-i or C-m.
# # One drawback of this approach arises when tmux is not in use. In such cases,
# # the custom sequence, which precedes the 'CSI u' sequence, is also transmitted
# # to the terminal program. While most terminal programs ignore unknown custom
# # sequences (like nvim), some may exhibit unexpected behavior. For instance, my
# # zsh-vi-mode plugin interprets this custom sequence as ESC, transitioning to
# # normal mode. However, this is a minor side effect since I do not use the keys
# # C-i and C-m in zsh.
# set -s user-keys[0] "\e[555;0~"
# bind -n User0 set key-table virt
# bind -T virt 'C-i' send Escape '[105;5u' \; set key-table root
# bind -T virt 'C-m' send Escape '[109;5u' \; set key-table root

# # Request extended keys keys from the terminal emulator. Not necessary for
# # kitty, as I've explicitly configured it to send CSI u sequences. However, this
# # request can prove valuable for other terminal emulators that may not have such
# # configurations in place.
# set -g extended-keys on
