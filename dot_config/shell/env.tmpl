#!/usr/bin/env sh
# vim: set ft=bash:

# This is a POSIX compliant file which defines shell-independent environment
# variables.

# Define ANSI palette aliases
background=0
darkest_grey=18
dark_grey=19
grey=8
bright_grey=20
foreground=7
bright_white=21
brightest_white=15
red=1
bright_red=9
orange=16
yellow=3
bright_yellow=11
green=2
bright_green=10
cyan=6
bright_cyan=14
blue=4
bright_blue=12
purple=5
bright_purple=13
dark_red=17

# Define XDG paths
export XDG_CACHE_HOME="$HOME/.cache"
export XDG_CONFIG_HOME="$HOME/.config"
export XDG_DATA_HOME="$HOME/.local/share"
export XDG_STATE_HOME="$HOME/.local/state"

# Fix config paths
export IPYTHONDIR="$XDG_CONFIG_HOME/jupyter"
export JUPYTER_CONFIG_DIR="$XDG_CONFIG_HOME/jupyter"
export CONDARC="$XDG_CONFIG_HOME/conda/condarc"
export WGETRC="$XDG_CONFIG_HOME/wget/wgetrc"
export STARSHIP_CONFIG="$XDG_CONFIG_HOME/starship/starship.toml"
export RIPGREP_CONFIG_PATH="$XDG_CONFIG_HOME/ripgrep/ripgreprc"
export INPUTRC="$XDG_CONFIG_HOME/readline/inputrc"

# Fix data paths
export GRADLE_USER_HOME="$XDG_DATA_HOME/gradle"
export CARGO_HOME="$XDG_DATA_HOME/cargo"
export RUSTUP_HOME="$XDG_DATA_HOME/rustup"
export CONDA_HOME="$XDG_DATA_HOME/miniconda"
export GOPATH="$XDG_DATA_HOME/go"

# Fix cache paths
export PYLINTHOME="$XDG_CACHE_HOME/pylint"

# Define colors for fzf
export FZF_DEFAULT_OPTS="\
    --color=bg:${background},fg:${bright_grey},hl:${blue} \
    --color=current-bg:${darkest_grey},current-fg:${bright_grey},current-hl:${blue} \
    --color=info:${cyan},border:${cyan},prompt:${bright_grey} \
    --color=pointer:${grey},marker:${purple},spinner:${red}"

sgr_fg() {
    if [ "$1" -lt 8 ]; then
        echo $((30 + $1))
    else
        echo $((90 + $1 - 8))
    fi
}

# File listing tools like ls and lsd use LS_COLORS for colorized output.
# LS_COLORS expects ANSI SGR color codes not palette indices, so our palette
# indices must be translated before being assigned.
LS_COLORS=""
LS_COLORS+="di=$(sgr_fg $blue):"       # directory
LS_COLORS+="ln=$(sgr_fg $foreground):" # symbolic link
LS_COLORS+="so=$(sgr_fg $yellow):"     # socket
LS_COLORS+="pi=$(sgr_fg $yellow):"     # named pipe
LS_COLORS+="ex=$(sgr_fg $red):"        # executable
LS_COLORS+="bd=$(sgr_fg $yellow):"     # block device
LS_COLORS+="cd=$(sgr_fg $yellow):"     # character device
LS_COLORS+="su=$(sgr_fg $purple):"     # setuid
LS_COLORS+="sg=$(sgr_fg $purple):"     # setgid
LS_COLORS+="tw=$(sgr_fg $purple):"     # sticky + world writable
LS_COLORS+="ow=$(sgr_fg $purple):"     # world writable
LS_COLORS+="or=$(sgr_fg $grey):"       # orphan symlink
LS_COLORS+="mi=$(sgr_fg $grey)"        # missing target
export LS_COLORS

# Plugin that adds transient prompt for starship
export TRANSIENT_PROMPT_TRANSIENT_PROMPT='$(starship module character)'
export TRANSIENT_PROMPT_TRANSIENT_RPROMPT=''

# Disable less history file
export LESSHISTFILE=-

# Use ANSI colors 0-21 for coloring. these are controlled by my tinted-terminal
export BAT_THEME='base16-256'

# Force aider AI to use my 16 ANSI colors
export PROMPT_TOOLKIT_COLOR_DEPTH=DEPTH_4_BIT

# My default editor
export EDITOR='nvim'

export LANG='en_US.UTF-8'

# Place for my custom compiled packages
export PATH="$HOME/.local/bin:$PATH"

# Add my custom script directory to PATH
if test -d "$XDG_DATA_HOME/scripts"; then
    export PATH="$PATH:$XDG_DATA_HOME/scripts"
fi

# Prepend in order to overwrite system installed cargo
if test -d "$CARGO_HOME/bin"; then
    export PATH="$CARGO_HOME/bin:$PATH"
fi

if test -d "$GOPATH/bin"; then
    export PATH="$PATH:$GOPATH/bin"
fi

if test -d "$XDG_DATA_HOME/nvim/mason/bin/"; then
    export PATH="$PATH:$XDG_DATA_HOME/nvim/mason/bin/"
fi

{{- if regexMatch "ubuntu|pop|raspberrypi|kali" .osid }}

if test -d '/snap/bin'; then
    export PATH="$PATH:/snap/bin"
fi

{{- end }}

{{- if contains "darwin" .osid }}

# Avoid macOS Java popup if no JDK is installed
if /usr/libexec/java_home >/dev/null 2>&1; then
    export JAVA_HOME="$("/usr/libexec/java_home")"
fi

# Export environment variables for homebrew
if test -x '/opt/homebrew/bin/brew'; then
    eval "$(/opt/homebrew/bin/brew shellenv zsh)"
fi

export HOMEBREW_NO_ENV_HINTS='true'

# TODO: Don't pin this on the version
if test -d "$HOME/Library/Python/3.9/bin"; then
    export PATH="$PATH:$HOME/Library/Python/3.9/bin"
fi

# Can be added to keychain with:
# security add-generic-password -a "$USER" -s openai_api_key -w "<key>" -U
export OPENROUTER_API_KEY="$(security find-generic-password -a "$USER" -s openai_api_key -w 2>/dev/null || true)"

{{- end }}

{{- if not .nerdfonts }}

export NO_NERDFONTS=true

{{- end }}
